<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="UE4,Performance," />










<meta name="description" content="主要记录一些能够查看UE4的性能工具和提升性能的一些手段记录。">
<meta name="keywords" content="UE4,Performance">
<meta property="og:type" content="article">
<meta property="og:title" content="UE4-Performance提升">
<meta property="og:url" content="http://stonelzp.github.io/2019/03/19/UE4-Performance提升/index.html">
<meta property="og:site_name" content="StoneのBLOG">
<meta property="og:description" content="主要记录一些能够查看UE4的性能工具和提升性能的一些手段记录。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-04-16T09:31:29.799Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="UE4-Performance提升">
<meta name="twitter:description" content="主要记录一些能够查看UE4的性能工具和提升性能的一些手段记录。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://stonelzp.github.io/2019/03/19/UE4-Performance提升/"/>





  <title>UE4-Performance提升 | StoneのBLOG</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">StoneのBLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">生活这种事情，从来都是自我陶醉</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://stonelzp.github.io/2019/03/19/UE4-Performance提升/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="stone">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="StoneのBLOG">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">UE4-Performance提升</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-19T19:47:59+09:00">
                2019-03-19
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-04-16T18:31:29+09:00">
                2019-04-16
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine4/" itemprop="url" rel="index">
                    <span itemprop="name">UnrealEngine4</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>主要记录一些能够查看UE4的性能工具和提升性能的一些手段记录。</p>
<a id="more"></a>
<p>我在知乎看见一篇文章整理的非常好：</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/36434616" target="_blank" rel="noopener">Performance and Profiling(UE4优化)</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/36851846" target="_blank" rel="noopener">Unreal 4 性能入门指南</a></li>
</ul>
<p>根据这个再根据自己在工作中遇到的问题进行进一步细致的总结吧。</p>
<p>发现了BasePass的消耗很高，查一下。</p>
<h1 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h1><p>关于一些渲染流程的说明：</p>
<ul>
<li><a href="https://www.slideshare.net/EpicGamesJapan/cedec2016-unreal-engine-4" target="_blank" rel="noopener">CEDEC2016: Unreal Engine 4 のレンダリングフロー総おさらい</a></li>
</ul>
<p>上面的文章我之前有总结过一些，但是并没有完全理解。</p>
<h2 id="Emulate-HMD-performance"><a href="#Emulate-HMD-performance" class="headerlink" title="Emulate HMD performance"></a>Emulate HMD performance</h2><p>下面有提到VRSDK的设置（v-sync）会使得帧数锁在90fps那里，如果小于90fps就会直接降到45fps，不能够正确的测试处理时间。</p>
<p>我们可以模拟VR的绘制：</p>
<ul>
<li><strong>Launch witch -emulatestereo</strong></li>
<li><strong>Set resolution 2160x1200</strong></li>
<li><strong>Set r.screenpercentage 140</strong></li>
</ul>
<p>具体的做法如下：</p>
<ol>
<li>在<em>Editor Preferences &gt; Play &gt; Play in Standalone Game &gt; Additional Launch Parameters</em>中填入 <code>-emulatestereo</code></li>
<li>Start with Standalone Mode and Set Resolution to <code>r.SetRes 2160x1200</code> or <code>r.SetRes 2160x1200f</code></li>
<li><code>r.screenpercentage 140</code></li>
</ol>
<h2 id="Ready-Profiling"><a href="#Ready-Profiling" class="headerlink" title="Ready Profiling"></a>Ready Profiling</h2><ul>
<li>Play in Standalone</li>
<li>Make sure the Editor is set to NOT update in realtime</li>
<li>Minimize the Editor</li>
<li>Make sure to turn off Frame Rate Smoothing[Project Settings]</li>
<li>Turn off VSync[r.vsync 0]</li>
</ul>
<p>使用<code>r.ScreenPercentage 10</code>命令，如果程序突然加速，说明性能瓶颈在GPU上。</p>
<p>引用来自下面的视频：</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=hcxetY8g_fs" target="_blank" rel="noopener">UE4 Performance and Profiling</a></li>
</ul>
<h2 id="VR-Instanced-Stereo"><a href="#VR-Instanced-Stereo" class="headerlink" title="VR Instanced Stereo"></a>VR Instanced Stereo</h2><p>这个可以在<br><strong>Edit &gt; Project Settings &gt; Rendering &gt; VR</strong></p>
<p>中开启。</p>
<p>目的是为了让双眼的画面同时渲染。减少Draw Call。</p>
<p>于是我试了试，并没有变快..反而感觉慢了，因为瓶颈本来不是CPU么。使用应该有条件的。</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-us/Platforms/VR/VRPerformance" target="_blank" rel="noopener">VR Instanced Stereo</a></li>
</ul>
<h2 id="1-Base-Pass"><a href="#1-Base-Pass" class="headerlink" title="1.Base Pass"></a>1.Base Pass</h2><p>关于base pass的总结：</p>
<ul>
<li><p><a href="https://unrealartoptimization.github.io/book/profiling/passes-base/" target="_blank" rel="noopener">UNREAL ART OPTIMIZATION - Base Pass</a></p>
<p>  <strong>Responsible for</strong></p>
<pre><code>• Rendering final attributes of Opaque or Masked materials to the G-Buffer

• Reading static lighting and saving it to G-Buffer

• Applying DBuffer decals

• Applying fog

• Calculating final velocity (from packed 3D velocity)

• In forward renderer: dynamic lighting
</code></pre><p>  <strong>Cost affected for</strong></p>
<pre><code>• Rendering resolution

• Shader complexity

• Number of objects

• Number of decals

• Triangle count
</code></pre></li>
</ul>
<p>在basepass阶段做了许多工作，其中<strong>Shader Complexity</strong> 是影响性能的一个很重要的因素。</p>
<h3 id="Optimization-1"><a href="#Optimization-1" class="headerlink" title="Optimization"></a>Optimization</h3><p>如何优化这个问题首先要知道那个地方需要优化。</p>
<ul>
<li>Shader Complexity: 在view-mode下可以查看shader的复杂度。</li>
<li>Stat: 在Material Editor里面有stat window查看pass的数量</li>
<li>Rendering Resolution: 可以查看和影响G-Buffer和其他贴图的质量。<ul>
<li><code>stat RHI</code>: 查看G-Buffer的内存占用</li>
</ul>
</li>
</ul>
<p>英文文章读起来不如中文的快，那么容易理解，但是有些话翻译成中文的话不知道为什么就变了味道。还是多读几遍人家的文章吧。</p>
<h3 id="GPU-Visualizer"><a href="#GPU-Visualizer" class="headerlink" title="GPU Visualizer"></a>GPU Visualizer</h3><h4 id="1-BasePass-Dynamic"><a href="#1-BasePass-Dynamic" class="headerlink" title="1.BasePass-Dynamic"></a>1.BasePass-Dynamic</h4><blockquote>
<p> <span style="color:red">BasePass 0 = Opaque Meshes.</span></p>
</blockquote>
<blockquote>
<p> <span style="color:red">BasePass 1 = Alpha Masked Opaque Meshes for Z-depth.</span></p>
</blockquote>
<blockquote>
<p> <span style="color:red">BasePass Dynamic = Animated Vertices such as Skeletal, GeoCache(Alembic),etc.</span></p>
</blockquote>
<p>在上面我只看到了<strong>Dynamic</strong>，而其他的是<strong>Static EBassPassDrawListType=0</strong>和<strong>Static EBasePassDrawListType=1</strong>意思是不是一样的我也不确定。</p>
<p>于是我查了查<strong>EBasePassDrawListType</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Source UnrealEngine4源码：Runtime\Render\Private\BasePassRendering.cpp</span></span><br><span class="line">EBasePassDrawListType DrawType = EBasePass_Default;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The definition of the type</span></span><br><span class="line"><span class="keyword">enum</span> EBasePassDrawListType</span><br><span class="line">&#123;</span><br><span class="line">    EBasePass_Default = <span class="number">0</span>,</span><br><span class="line">    EBasePass_Masked,</span><br><span class="line">    EBasePass_MAX</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看这个声明貌似上面的是对的。</p>
<p>还有一个我有点在意的是在VR的模式下会出现两种</p>
<ul>
<li>View0</li>
<li>View1</li>
</ul>
<p>这两种处理，一开始我认为是两个摄像机的存在导致的，删了一个摄像机没啥影响。后来新建了一个新的VR项目试试发现原本就会有两个摄像机（Runtime），一个VR设备用另一个不知道干啥的，运行时会生成。查了一下也没找到，先写下来。</p>
<p>但是现在我有点明白了，VR眼镜不是有两个镜片么，就对应了两个摄像机不是么，我也是傻了。</p>
<p>所以<strong>Dynamic</strong>处理占用时间，是因为<strong>顶点动画</strong>比较多。</p>
<h2 id="2-PrePass"><a href="#2-PrePass" class="headerlink" title="2.PrePass"></a>2.PrePass</h2><p>我看到的不是单单的<strong>PrePass</strong>，而是<strong>PrePass DDM_AllOpaque(Forced by DBuffer)</strong>。</p>
<p>这个Pass是用来先行计算<strong>Depth-Buffer</strong>的，在BasePass把数据写G-Buffer之前，把深度通过测试的像素留下，达到减少处理的目的，但是不是一定会减少。</p>
<p>这个可以ON/OFF，也可以开启之后指定物体经不过经过该处理。</p>
<p>所以说PrePass的目的是为了减少BasePass的处理负荷。</p>
<p>我在项目中发现的特点是：在所有的View0/View1中的处理中，还是<strong>Dynamic</strong>的时间最长。上面也有提到当动态的顶点，skeleton动画比较多的时候就会这样，可以试试关掉PrePass或者把顶点动画的物体不经过该Pass处理会不会减轻一些负担。但是在此之前，我应该学会如何使用Profile工具。</p>
<h2 id="3-Translucency"><a href="#3-Translucency" class="headerlink" title="3.Translucency"></a>3.Translucency</h2><p>按照处理顺序的话透明处理绝对不是那么靠前，之后应该调整一下顺序。</p>
<h3 id="Separate-Translucency"><a href="#Separate-Translucency" class="headerlink" title="Separate Translucency"></a>Separate Translucency</h3><p>把半透明的处理写到其他的Buffer中。</p>
<p><strong>Project Settings &gt; Engine &gt; Rendering &gt; Translucency</strong></p>
<p>我似乎有看过一点这方面的文章。</p>
<ul>
<li><code>r.SeparateTranslucencyScreenPercentage XX</code>: 指定该buffer的解像度</li>
<li><code>r.SeparateTranslucencyAutoDownsample</code>: 自动降低解像度</li>
</ul>
<h2 id="4-Shadow"><a href="#4-Shadow" class="headerlink" title="4.Shadow"></a>4.Shadow</h2><p>阴影这一部分的内容有很多，顺序也需要之后调整。</p>
<h3 id="Fake-Shadow"><a href="#Fake-Shadow" class="headerlink" title="Fake Shadow"></a>Fake Shadow</h3><p>多在角色模型中使用，比如人物脚下一团黑影代表着阴影那样。</p>
<h3 id="Capsule-Shadow"><a href="#Capsule-Shadow" class="headerlink" title="Capsule Shadow"></a>Capsule Shadow</h3><ul>
<li>SkeletalMesh: Capsule Direct(Indirect) Shadow 等等</li>
</ul>
<h2 id="Command-Introduction"><a href="#Command-Introduction" class="headerlink" title="Command Introduction"></a>Command Introduction</h2><p>记录一些常用的命令和里面的参数解读。</p>
<h3 id="stat-SceneRendering"><a href="#stat-SceneRendering" class="headerlink" title="stat SceneRendering"></a>stat SceneRendering</h3><h4 id="RenderQueryResult"><a href="#RenderQueryResult" class="headerlink" title="RenderQueryResult"></a>RenderQueryResult</h4><p>关于这个参数，我也不太完全确定，在网上搜了也没有什么具体的答案。搜来搜去看到了<strong>OcclusionCulling</strong>感觉很像，但是按照这个方向去优化了一下试了试并不是很理想，貌似不是并不是一个概念，而且OcclusionCulling这个参数在另外一个命令，貌似是<em>stat InitView</em>中有貌似。</p>
<p>看到有人理解的是：</p>
<p><strong>RenderQueryResult是GPU完成整个一帧的渲染最后要做的事情。这个条目耗费时间很长说明GPU在这一帧内没有空闲，一直在工作。</strong></p>
<p>感觉还说的过去。</p>
<h1 id="Bluerint优化"><a href="#Bluerint优化" class="headerlink" title="Bluerint优化"></a>Bluerint优化</h1><p>像Blueprint和C++是由CPU处理的<strong>Game</strong>阶段的处理。</p>
<h2 id="Tick-Event"><a href="#Tick-Event" class="headerlink" title="Tick Event"></a>Tick Event</h2><p>如果不需要的话，将Actor中的Tick Enable 设置为Off。亦或者调整Tick Interval的数值减少每一帧的调用。</p>
<h2 id="Spawn"><a href="#Spawn" class="headerlink" title="Spawn"></a>Spawn</h2><p>Spawn处理不一定非要在一帧之内完成，可以分散到下下帧，由于间隔时间很短所以不会暴露什么。</p>
<p>但是分帧完成一个动作我还没见过这种操作，之后有时间找找看吧。</p>
<h2 id="Nativizing-Blueprint"><a href="#Nativizing-Blueprint" class="headerlink" title="Nativizing Blueprint"></a>Nativizing Blueprint</h2><p>这个我也不太懂，真要用的时候再看吧。</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-US/Engine/Blueprints/TechnicalGuide/NativizingBlueprints" target="_blank" rel="noopener">Nativizing Blueprint</a></li>
</ul>
<h1 id="Landscape-Optimization"><a href="#Landscape-Optimization" class="headerlink" title="Landscape Optimization"></a>Landscape Optimization</h1><p>自作大型的场景的时候就会用到Landscape，但是问题是在Statistics中查看的结果，这个东西的无论是顶点数还是资源大小还是光照贴图的大小都是场景里耗费最高的。</p>
<p>关于Landscape的制作也不是随意的。</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=OWOlYoI-3tY" target="_blank" rel="noopener">Introduction to Landscapes - #6 Unreal Engine 4 Level Design Tutorial Series</a></li>
</ul>
<p>这个视频涉及到了如何合理的制作Landscape，还有其他的系列视频关于如何使用Landscape的工具的。</p>
<p>再就是官方文档了：</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-us/Engine/Landscape/TechnicalGuide" target="_blank" rel="noopener">Landscape Technical Guide</a></li>
</ul>
<p>解释了各种参数的意义和推荐设置。</p>
<p>还有就是一些具体细节的调整：</p>
<ol>
<li>Navigation不用的话关掉</li>
<li>Collision不用的话关掉</li>
<li>LOD设置调低</li>
</ol>
<h1 id="HTC-Vive"><a href="#HTC-Vive" class="headerlink" title="HTC Vive"></a>HTC Vive</h1><p><strong>Vive的刷新率只有90Hz。</strong></p>
<p>这是什么概念？每秒刷新90帧的能力，这跟游戏能够达到的帧率有很大不同。</p>
<ol>
<li>这里就有疑问了，如果游戏的帧率高于显示器（VR）的刷新率会怎么样。</li>
</ol>
<p><span style="color:red"><strong>会造成撕裂(tearing)。</strong></span></p>
<p>GPU活儿干多了，比如说应该把一帧的图像交给显示器，结果交付了一帧还多的数据（显示器来取数据的速度慢了一拍，本应该取走的一帧数据被显卡二次更新中途，）。产生了画面撕裂。</p>
<p><strong>V-Sync</strong>被用来解决这个问题，垂直同步(Vertical Synchronization)通过建立一个不让在显示器刷新前将后备缓冲中的画面拷贝到显示缓冲中的规定来解决这个问(有条件的双倍缓冲)。如果FPS高于刷新率的话没有问题，后备缓冲的更新完成后，系统处于等待状态。当显示器刷新后，后备缓存拷入显示缓存，显卡则可以在后备缓存中描画新的画面。</p>
<ol start="2">
<li>游戏的帧率低于显示器（VR）的刷新率会怎样</li>
</ol>
<p>如果打开了垂直同步，那么帧数直接减半。理论上讲，双缓冲的VSync，FPS将是一组不连续的整数，其等于<strong>刷新率/n</strong>。</p>
<p>这就是为什么我总是看Vive的帧率被锁在45帧的原因。</p>
<p>那么进入正题，UE4中的<strong>Smoothed Frame Rate Range</strong>有什么用。</p>
<h2 id="Smoothed-Frame-Rate-Range"><a href="#Smoothed-Frame-Rate-Range" class="headerlink" title="Smoothed Frame Rate Range"></a>Smoothed Frame Rate Range</h2><ul>
<li><a href="https://answers.unrealengine.com/questions/90743/what-exactly-does-smooth-frame-rate-do.html" target="_blank" rel="noopener">What exactly does “Smooth Frame Rate” do?</a></li>
</ul>
<blockquote>
<p><strong>With Frame Rate Smoothing, the application is determining what range is acceptable for frame rate wandering,so you can cap your frame rate to between Min and Max allowable frame rates.Since this is application based,it will make these changes before any hardware vsync changes.</strong></p>
</blockquote>
<p>举例来说，如果设置了Max60f，Min40f的话，当超过60帧会保持在60帧，当低于60帧而高于40帧的时候会保持帧数，但是低于40帧的时候就会降到30帧。</p>
<p>得益于现在的显卡很多具有自适应的垂直同步功能。</p>
<p>当然上面的内容只是我看文章得到的，并没有实际试验过。</p>
<p>然后吧，我读到了一篇文章。</p>
<ul>
<li><a href="https://software.intel.com/zh-cn/articles/cpu-performance-optimization-and-differentiation-for-unreal-engine-4-vr-application-part1" target="_blank" rel="noopener">Unreal* Engine 4 VR应用的CPU性能优化和差异化：第一部分</a></li>
</ul>
<p>这里面提到了<strong>另外，因为VR是强制开启垂直同步的，所以只要一帧的渲染时间超过11.1ms，即使只超过0.1ms，也会导致一帧需要花两个完整的垂直同步周期完成，使得VR应用很容易因为场景稍微改变而出现性能大降的情形。这时候可以用“–emulatestereo”指令，同时把分辨率(resolution)设为2160x1200，屏幕百分比(screenpercentage)设为140，就可以在没有接VR头显及关闭垂直同步的情况下分析性能。</strong></p>
<p>好的。</p>
<h1 id="UE4中的一些概念"><a href="#UE4中的一些概念" class="headerlink" title="UE4中的一些概念"></a>UE4中的一些概念</h1><h2 id="Instanced-Static-Mesh"><a href="#Instanced-Static-Mesh" class="headerlink" title="Instanced Static Mesh"></a>Instanced Static Mesh</h2><p>关于这个东西，我纠结了好久。我是从<strong>foliage</strong>这个东西接触到它的。因为foliage刷出来的东西就是这个类型，生成一些随机的树啊花啊草啊就很方便，但是同时带来了性能消耗。</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-us/Engine/Foliage" target="_blank" rel="noopener">Foliage Instanced Meshes</a></li>
</ul>
<p>为什么说带来了性能消耗呢，其实除了方便之外还有其他的好处。</p>
<ul>
<li>减少了<strong>Draw Call</strong></li>
</ul>
<p>据我的理解：<strong>一个Actor的渲染对于CPU来说就得生成一个draw call</strong>，所以庞大的Actor的数量会拖CPU的后腿，减少draw call是优化性能的方向之一。</p>
<p>但是与此同时，一个draw call的数据不充分就导致GPU做额外的工作。也就是我遇见的InstancedStaticMesh这个东西产生的影响。</p>
<h3 id="剔除"><a href="#剔除" class="headerlink" title="剔除"></a>剔除</h3><p>有两种剔除方式：</p>
<ul>
<li>Frustum Culling</li>
<li>Occlusion Culling</li>
</ul>
<p>对于InstancedStaticMesh来说，第一种视椎体剔除是可以降看不见的部分剔除的。而第二种遮挡剔除，对于它来说就完全不起作用了，反而加重了GPU的负担。</p>
<p>我这么认为的证据是，在我分析一个用满是foliage制作的大场景中，我试着：</p>
<ol>
<li>ToggleDebugCamera: 命令行打开Debug摄像机，找到想要看的位置</li>
<li>FreezeRendering:</li>
</ol>
<p>我忘记上面的命令是在哪里看到的了，在我暂停了渲染之后移动摄影机之后发现，在摄像机之外的内容被剔除掉但是在摄像机之内的所有InstancedStaticMash都还在。即下面的文章中提到的：</p>
<ul>
<li><a href="https://software.intel.com/en-us/articles/unreal-engine-4-optimization-tutorial-part-2" target="_blank" rel="noopener">Unreal* Engine 4 Optimization Tutorial, Part 2</a></li>
</ul>
<blockquote>
<p>One thing to know about instanced static meshes is that if any part of the mesh is rendered, the whole of the collection is rendered. This wastes potential throughput if any part is drawn off camera. It’s recommended to keep a single set of instanced meshes in a smaller area; for example, a pile of stone or trash bags, a stack of boxes, and distant modular buildings.</p>
</blockquote>
<p>如果将Foliage的部分做的很大，那么所有的内容都会被渲染，哪怕是一小部分进到了摄像机的视野里。</p>
<p>还要一种方式是在Editor中，不是运行的状态，输入命令：</p>
<ul>
<li>r.VisualOccludedPrimitives</li>
</ul>
<p>可以实时的查看被遮挡的物体的轮廓，上面的例子中，并看不见InstancedStaticMesh被遮挡的轮廓，因为他们是一体的，只要一部分出现在了视野里就会被渲染。</p>
<p>这里我突然就产生了对<em>遮挡</em>这个功能的疑惑，遮挡剔除这个部分对Instanced类型的物体做的不是很好，或者说是根本无能为力。按照我之前的理解，对看不见的片元，CPU和GPU不会去渲染才对，但是结果是，遇见这种类型的，都会被渲染，看不见的片元被渲染浪费了大量的GPU的能力和处理时间。<strong>GPU并没有认为这是一个物体，把出现在视野内的片元渲染，看不见的片元舍弃，而是全部听从了CPU的命令进行全部的渲染。</strong></p>
<p>这个是我之前的理解。</p>
<p>但是对于视野内的物体，遮挡剔除就完美的降被遮挡的非Instanced物体给剔除掉了，这是事实。</p>
<p><strong>遮挡剔除究竟是CPU的工作还是GPU的工作？</strong></p>
<h3 id="关于OcclusionCulling的一些问题"><a href="#关于OcclusionCulling的一些问题" class="headerlink" title="关于OcclusionCulling的一些问题"></a>关于OcclusionCulling的一些问题</h3><ul>
<li><a href="http://darakemonodarake.hatenablog.jp/entry/20181204-01-OcclusionCulling" target="_blank" rel="noopener">UE4のOcclusion Cullingで良く聞かれる質問1: Occlusion Culling自身の処理負荷を減らしたい - だらけ者だらけ</a></li>
<li><a href="http://darakemonodarake.hatenablog.jp/entry/20181204-02-OcclusionCulling" target="_blank" rel="noopener">UE4のOcclusion Cullingで良く聞かれる質問2 Occlusion Cullingによりオブジェクトが1フレーム消失することがある - だらけ者だらけ</a></li>
</ul>
<p>上面是关于遮挡剔除的一些问题的文章。重点是在第二篇。</p>
<p>这里提到了一些遮挡剔除的特性：</p>
<p>当摄像机的移动超过了一定的阈值OcclusionCulling就会Off</p>
<ul>
<li><code>CameraRotaionThreshold(Default 45.0)</code></li>
<li><code>CameraTranslationThreshold(Default 1000)</code></li>
</ul>
<p>另外，<code>r.AllowOcclusionQueries</code> 的ON/OFF 可以手动切换。</p>
<p>也可以通过扩大Occlusion的Bound来提前渲染object</p>
<ul>
<li><code>OCCLUSIN_SLOP</code></li>
<li><code>r.ExpandAllOcclusionTestedBBoxedAmount</code></li>
</ul>
<p>进入摄像机视野的一瞬间扩大OcclusionBound：</p>
<ul>
<li><code>r.ExpandNewlyOcclusionTestedBBoxsAmount(Default=0.0f)</code></li>
</ul>
<h3 id="简单的Profiling"><a href="#简单的Profiling" class="headerlink" title="简单的Profiling"></a>简单的Profiling</h3><ul>
<li>stat SceneRendering</li>
<li>stat InitView</li>
<li>Stat SceneUpdate</li>
</ul>
<p>命令应该别的地方有讲过。但是这里我注意到的是在<code>stat InitView</code>命令里，有一个处理占了我很多时间</p>
<h3 id="Render-Query-Result"><a href="#Render-Query-Result" class="headerlink" title="Render Query Result"></a>Render Query Result</h3><p>查了也不是很明白</p>
<blockquote>
<p>RenderQuery Result is when the render thread stalls waiting for the GPU to finish the Occlusion Query, and return the results to the render thread, so that it knows what to render.</p>
</blockquote>
<blockquote>
<p>At the same time, the game thread is stalled waiting for the render thread.</p>
</blockquote>
<blockquote>
<p>This can be turned on or off with the console command</p>
</blockquote>
<blockquote>
<p>r.AllowOcclusionQueries</p>
</blockquote>
<blockquote>
<p>0 - off 1 - on</p>
</blockquote>
<p>看了也不太懂系列。</p>
<p>什么是<strong>Occlusion Query</strong>?</p>
<ul>
<li><a href="http://developer.download.nvidia.com/books/HTML/gpugems/gpugems_ch29.html" target="_blank" rel="noopener">GPU Gems- Chapter 29. Efficient Occlusion Culling</a></li>
</ul>
<p>我下了PDF，可以看。</p>
<h3 id="如何正确的使用"><a href="#如何正确的使用" class="headerlink" title="如何正确的使用"></a>如何正确的使用</h3><ul>
<li><a href="https://www.youtube.com/watch?v=oMIbV2rQO4k" target="_blank" rel="noopener">UE4 Optimization : Instancing</a></li>
</ul>
<p>我觉得这个人的每个视频都值得我刷几遍。</p>
<h3 id="Culling-Distance"><a href="#Culling-Distance" class="headerlink" title="Culling Distance"></a>Culling Distance</h3><ol>
<li>Foliage Culling Distance</li>
<li>Culling Distance Volumn</li>
</ol>
<h1 id="UE4-Performance-and-Profiling"><a href="#UE4-Performance-and-Profiling" class="headerlink" title="UE4 Performance and Profiling"></a>UE4 Performance and Profiling</h1><p>实际上准确的标题名字应该是</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=hcxetY8g_fs" target="_blank" rel="noopener">UE4 Performance and Profiling | Unreal Dev Day Montreal 2017 | Unreal Engine</a></li>
</ul>
<p>这其实是一个视频，我尝试的边看边做笔记，结果足足整理了三页，虽然是就是抄的英文，等之后有时间再记录下来吧。</p>
<p>现在要将这些内容整理一下，同时也温习一下视频的内容。</p>
<h2 id="1-CPU-GPU-Profiler"><a href="#1-CPU-GPU-Profiler" class="headerlink" title="1.CPU/GPU Profiler"></a>1.CPU/GPU Profiler</h2><p>我觉得有必要区分这两种Profiler，因为我最近接触的总是GPUProfiler，搞得我都不知道CPU要怎么Profiling了。</p>
<h2 id="2-Profiling-in-a-Build"><a href="#2-Profiling-in-a-Build" class="headerlink" title="2.Profiling in a Build"></a>2.Profiling in a Build</h2><p>算是准备优化之前的准备工作吧。</p>
<ol>
<li><p>Minimize the noise that can interface with profiling</p>
<ul>
<li>Turn off everything you are not using</li>
<li>Turn off v-sync <code>r.vsync 0</code></li>
</ul>
</li>
<li><p>Turn off Framerate Smoothing</p>
</li>
<li><p>Make a Test build</p>
<ul>
<li>Testing in a Development build inflates the Draw thread with noise</li>
</ul>
</li>
</ol>
<p>尽可能的关闭噪声（noise），前两项是必须要做的，但是第三项，我也不太清楚我理解对不对，开发的时候使用的是<strong>Development mode</strong>，所以尽可能的减少噪音就直接build工程（即<strong>Shipping mode</strong>）来optimization。</p>
<p>但是吧，还能不能用<em>stat</em>一类的命令来debug了我还真没试过。</p>
<h2 id="3-Profiling-from-within-the-Editor"><a href="#3-Profiling-from-within-the-Editor" class="headerlink" title="3.Profiling from within the Editor"></a>3.Profiling from within the Editor</h2><p>可能就是上面的补充吧，其实我也是这么做的。在Editor中Optimization肯定会有noise。</p>
<p>前面也有提到具体怎么做(虽然是VR的，但是应该都一样)这里就简单抄一下。</p>
<ol>
<li>Play in Standalone</li>
<li>Make sure the Editor is set to NOT update i realtime</li>
<li><p>Minimize the Editor</p>
<ul>
<li>VR &gt; Editor Preference &gt; Play &gt; should minimize Editor on VRPIE</li>
</ul>
</li>
<li><p>Make sure to turn off Frame Rate Smoothing</p>
</li>
<li>Turn off VSync</li>
</ol>
<h2 id="4-General-Process"><a href="#4-General-Process" class="headerlink" title="4.General Process"></a>4.General Process</h2><ol>
<li><p>Identify the bottleneck</p>
<ul>
<li>Game Thread</li>
<li><p>Render Thread</p>
<ul>
<li>CPU</li>
<li>GPU</li>
</ul>
</li>
<li><p>Often jumps back and forth as you optimize</p>
</li>
<li>Use <code>r.ScreenPercentage 10</code> to quickly check if you are GPU bound</li>
</ul>
</li>
</ol>
<p>最后一条很有用。</p>
<h3 id="Game-Thread"><a href="#Game-Thread" class="headerlink" title="Game Thread"></a>Game Thread</h3><ul>
<li>Code or Blueprint</li>
</ul>
<h3 id="CPU-Render"><a href="#CPU-Render" class="headerlink" title="CPU Render"></a>CPU Render</h3><ul>
<li>Object count,draw calls,culling</li>
</ul>
<h3 id="GPU-Render"><a href="#GPU-Render" class="headerlink" title="GPU Render"></a>GPU Render</h3><ul>
<li>Shaders, overdraw,light</li>
</ul>
<h2 id="5-Measuring-in-Milliseconds"><a href="#5-Measuring-in-Milliseconds" class="headerlink" title="5.Measuring in Milliseconds"></a>5.Measuring in Milliseconds</h2><ul>
<li><p>Use <em><span style="color:green">stat unit</span></em>,not just <em><span style="color:green">stat fps</span></em></p>
<ul>
<li>Largest number shows you the likely bottleneck</li>
</ul>
</li>
<li><p>Milliseconds per frame</p>
<ul>
<li><span style="color:grey">Frame:</span> total time to finish each frame</li>
<li><span style="color:red">Game:</span> C++ or BP gameplay operations</li>
<li><span style="color:blue">Draw:</span> CPU render time</li>
<li><span style="color:purple">GPU:</span> GPU render time</li>
</ul>
</li>
<li>You can also use <em><span style="color:green">stat unitGraph</span></em>,whitch shows a line graph playback.<ul>
<li>Mostly useful for spotting repeating hitches</li>
</ul>
</li>
</ul>
<h3 id="ScreenPercentage"><a href="#ScreenPercentage" class="headerlink" title="ScreenPercentage"></a>ScreenPercentage</h3><p>前面有提到使用这个命令来模拟VR的性能，还有就是使用这个命令来快速确认游戏的性能瓶颈是不是GPU。</p>
<ul>
<li>Mostly useful to measure problems unrelated to Game Thread</li>
<li>Use <em>stat unit</em> to show milliseconds</li>
<li>Use <em><span style="color:green">r.ScreenPercentage 10</span></em><ul>
<li>Or any number smaller than 100</li>
<li>Reduces number od pixels sent to the GPU</li>
<li>If things get faster,you were GPU bound</li>
<li>If they dont get faster,you were CPU bound</li>
</ul>
</li>
</ul>
<h2 id="6-Show-Flags"><a href="#6-Show-Flags" class="headerlink" title="6.Show Flags"></a>6.Show Flags</h2><p>One of the simplest ways to look for problems is to turn off partsof your scene.</p>
<p>Helps know when to look into reducing</p>
<ul>
<li>LODs</li>
<li>Less translucency</li>
<li>Adjust lighting</li>
</ul>
<p><em><span style="color:green">show assetType</span></em> or <em><span style="color:green">showFlag.assetType 0-1</span></em></p>
<ul>
<li>Staticmeshes</li>
<li>Skeletalmeshes</li>
<li>Particles</li>
<li>Lighting</li>
<li>Transluncency</li>
<li>Reflectionenvironment</li>
<li>Many more listed in docs</li>
</ul>
<h2 id="7-Diagnostic-Tools-Realtime-stats-and-view-modes"><a href="#7-Diagnostic-Tools-Realtime-stats-and-view-modes" class="headerlink" title="7.Diagnostic Tools-Realtime stats and view modes"></a>7.Diagnostic Tools-Realtime stats and view modes</h2><h3 id="Stat-commands"><a href="#Stat-commands" class="headerlink" title="Stat commands"></a>Stat commands</h3><ul>
<li><em><span style="color:green">stat fps</span></em></li>
<li><em><span style="color:green">stat unit</span></em></li>
<li><em><span style="color:green">stat scenerendering</span></em></li>
<li><em><span style="color:green">stat gpu</span></em></li>
<li><em><span style="color:green">stat engine</span></em></li>
<li><em><span style="color:green">stat streaming</span></em></li>
<li><em><span style="color:green">stat emitters</span></em></li>
<li><em><span style="color:green">stat lighting</span></em></li>
</ul>
<p><span style="color:green"></span></p>
<h4 id="Stat-SceneRendering"><a href="#Stat-SceneRendering" class="headerlink" title="Stat SceneRendering"></a>Stat SceneRendering</h4><ul>
<li><p>Only place to see draw calls</p>
<ul>
<li>Draw call is a single request to GPU to draw something</li>
<li>Prime candidate for CPU slowdown on lower-end machines and also on mobile(less of a concern with Metal and Vulkan)</li>
</ul>
</li>
<li><p>Also good palce to see time for:</p>
<ul>
<li>Shadows</li>
<li>Decals</li>
<li>Post Processing</li>
<li>Lighting</li>
</ul>
</li>
</ul>
<p>这个命令挺重要的。</p>
<h4 id="Stat-GPU"><a href="#Stat-GPU" class="headerlink" title="Stat GPU"></a>Stat GPU</h4><ul>
<li>Relatively new 4.15</li>
<li>Realtime readout from GPU</li>
<li><p>Gives highlights, but not details</p>
<ul>
<li>Makes i very good to quickly target trouble spots</li>
</ul>
</li>
<li><p>Use the full GPU profiler if you want to target individual things</p>
<ul>
<li>Example:if you want to find specific lights that are casting shadows</li>
</ul>
</li>
</ul>
<h3 id="Optimization-View-Modes"><a href="#Optimization-View-Modes" class="headerlink" title="Optimization View Modes"></a>Optimization View Modes</h3><h4 id="Shader-Complexity"><a href="#Shader-Complexity" class="headerlink" title="Shader Complexity"></a>Shader Complexity</h4><ul>
<li>Show how much your shhaders are costing on the GPU</li>
<li><p>Good way to see overdraw issues</p>
<ul>
<li>Overdraw is when a pixel must be drawn multiple times</li>
<li>One of the most common content issues for optimization</li>
</ul>
</li>
<li><p>Graph at the bottom shows where the pixel and vertex shaders are in terms of performance</p>
</li>
<li>If you see a lot of red and white,reconsider your approach</li>
</ul>
<p>下面的话来自于官方文档里的</p>
<ul>
<li><a href="https://docs.unrealengine.com/en-us/Engine/UI/LevelEditor/Viewports/ViewModes" target="_blank" rel="noopener">View Modes</a></li>
</ul>
<blockquote>
<p>Shader Complixty Mode is used to visualize the number of shader instructions being used t calculate each pixel ofour scene.It i a generally a good indicating of how performance-friendly your scene will be. In general, it is used to test overall performance for your base scene, as well as to optimize particle effects, which tend to cause performance spikes with a large amount of overdraw for a short period of time.</p>
</blockquote>
<h4 id="Quad-Overdraw"><a href="#Quad-Overdraw" class="headerlink" title="Quad Overdraw"></a>Quad Overdraw</h4><ul>
<li>Helps show how you are using your polygon count on the screen</li>
<li><p>Can help show where meshes should be LOD-ed down</p>
<ul>
<li>Too much green shows areas that should be simplified</li>
<li>Anything more than green is starting to get costly, commonly translucency overdraw</li>
</ul>
</li>
<li><p>Very useful for MSAA on Forward Rendering,as the number of poly edges dramatically affects performance</p>
</li>
</ul>
<h4 id="Quad-Overdraw-in-depth"><a href="#Quad-Overdraw-in-depth" class="headerlink" title="Quad Overdraw in-depth"></a>Quad Overdraw in-depth</h4><ul>
<li><p>Your GPU breaks the view up into quads</p>
<ul>
<li>2*2 groups of pixels</li>
<li>This is more efficient than performing all operations on all pixels</li>
</ul>
</li>
<li><p>Very small, or very long, thin geometry wastes pixels</p>
<ul>
<li>Regular, large polygons make the best use of pixel quads, best use of GPU</li>
</ul>
</li>
<li><p>Model with regular trangles and LDD aggressively</p>
</li>
</ul>
<blockquote>
<p>When you are looking at an opaque object on the deferred render, and you see a lot of green ,that means all 4 pixels of that quad had to be recalculated over and over.</p>
</blockquote>
<blockquote>
<p>you should probably be using lower LODs.</p>
</blockquote>
<h4 id="Shader-Complexity-Quad-Overdraw"><a href="#Shader-Complexity-Quad-Overdraw" class="headerlink" title="Shader Complexity + Quad Overdraw"></a>Shader Complexity + Quad Overdraw</h4><ul>
<li>Combines two powerful view modes into one</li>
<li>USeful to get an idea of expensive shader anf geometry at a glance</li>
<li>You will still need the individual settings to help diagnose specifics</li>
</ul>
<h4 id="Liht-Complexity"><a href="#Liht-Complexity" class="headerlink" title="Liht Complexity"></a>Liht Complexity</h4><ul>
<li>Visualizes the cost of scene lighting</li>
<li>As lights overlap, the colors shift from cool to warm to white</li>
<li>Only shows cost of lighting, not shadowing</li>
<li>Obviously, white is bad</li>
<li>Great way to see where you should be lowing light radii</li>
<li>By flipping this on and off, you can quickly see if the cost of any given light is “worth it”</li>
</ul>
<h4 id="Lightmap-Density"><a href="#Lightmap-Density" class="headerlink" title="Lightmap Density"></a>Lightmap Density</h4><ul>
<li>Shows the density of texels for lightmap purposes</li>
<li><p>Color shifts from cool to warm an density increases</p>
<ul>
<li>Most things can be blue</li>
<li>Shadow maps don’t often need to be very high res</li>
</ul>
</li>
<li><p>Keep this as low as possible</p>
<ul>
<li>Cost adds up quickly</li>
</ul>
</li>
</ul>
<h4 id="Stationary-Light-Overlap"><a href="#Stationary-Light-Overlap" class="headerlink" title="Stationary Light Overlap"></a>Stationary Light Overlap</h4><ul>
<li>Only a maxium of 4 stationary lights can affect any given object</li>
<li>Beyound that,any other lights fall back to Movable(fully dynamic)</li>
<li>This view mode helps track down where that might be happening</li>
<li>Reminder to keep lighth radii as small as you can get it</li>
<li>Do you have a stationary sun?<ul>
<li>Congratulations! That’s one of the four lights!</li>
</ul>
</li>
</ul>
<h4 id="LOD-Coloration"><a href="#LOD-Coloration" class="headerlink" title="LOD Coloration"></a>LOD Coloration</h4><ul>
<li>This mode shows the current mesh LODs in use by color coding them</li>
<li>Very fast way to through ypur scene and verify that things are LODing when they should be</li>
<li>Interestingly, mode clearly shows that the trees are not LODing at all in this project<ul>
<li>Was able to diagnose frame drop instantly using this mode</li>
</ul>
</li>
</ul>
<h2 id="8-Profilling-Tools"><a href="#8-Profilling-Tools" class="headerlink" title="8.Profilling Tools"></a>8.Profilling Tools</h2><h3 id="CPU-Profiling"><a href="#CPU-Profiling" class="headerlink" title="CPU Profiling"></a>CPU Profiling</h3><ul>
<li><p>Integrated tool to take apart a segment od your gameplay and see wat’s happening on each tick</p>
<ul>
<li>Very useful way to profile Blueprint performance</li>
</ul>
</li>
<li><p>Measures a segment of time</p>
<ul>
<li>Within that segment, can look a individual frames or averages</li>
</ul>
</li>
<li><p>Requires two special Stat Commands</p>
<ul>
<li><em><span style="color:green">stat startfile</span></em> &amp; <em><span style="color:green">stat stopfile</span></em></li>
<li>Tese generate a log file between the interval of the commands</li>
<li>Profiller allows deep analysis that log</li>
</ul>
</li>
<li><p>Step down into world tick and see individual Blueprint functions</p>
</li>
<li>Can be used for CPU(Game and Draw) and GPU</li>
</ul>
<p>捕获下来的日志可以在UE4的<strong>Session Frontend</strong>中展开分析。</p>
<h3 id="GPU-Profiling"><a href="#GPU-Profiling" class="headerlink" title="GPU Profiling"></a>GPU Profiling</h3><ul>
<li><p>Three method to profile GPU functions</p>
<ul>
<li><span stype="color:green">stat GPU</span> command in tne viewport</li>
<li>Recorded file log in the <strong>Session Frontend</strong></li>
<li>GPU Profiler<ul>
<li>Can dump out to either the log or its own UI</li>
</ul>
</li>
</ul>
</li>
<li><p>Great way to visualize the cost of:</p>
<ul>
<li>Base pass</li>
<li>Lighting</li>
<li>Shadows</li>
<li>Post processing</li>
</ul>
</li>
</ul>
<h3 id="Tracking-Slow-Frame"><a href="#Tracking-Slow-Frame" class="headerlink" title="Tracking Slow Frame"></a>Tracking Slow Frame</h3><ul>
<li><p><em><span style="color:green">stat dumpHitches</span></em></p>
<ul>
<li>The command is used to dump any hitched over a given time in milliseconds out to the log</li>
<li>Use command <em><span style="color:green">t.hitchThreshhold 0.xx</span></em> to set value (0.05 is default)</li>
</ul>
</li>
<li><p><em><span style="color:green">memReport -full</span></em></p>
<ul>
<li>Full breakdown of how memory is being used</li>
<li>There’s a great blog post on how this works</li>
</ul>
</li>
</ul>
<p>虽然我还没有尝试过但是我可以使用上面的命令来找到游戏运行时候突然消耗非常高的那一帧究竟做了什么。</p>
<h3 id="startFPSChart-and-stopFPSChart"><a href="#startFPSChart-and-stopFPSChart" class="headerlink" title="startFPSChart and stopFPSChart"></a>startFPSChart and stopFPSChart</h3><ul>
<li><p>You can use the commands <em><span style="color:green">startFPSChart/span&gt;</span></em> and <em><span style="color:green">stopFPSChart/span&gt;</span></em> to create a diagram of framerates over time</p>
</li>
<li><p>You can call these at start and end of a Level Sequence to automatically read out the frame rates along a given course, as defined by a cinematic</p>
</li>
</ul>
<p>这里使用完这个命令之后会输出日志文件，需要使用别的软件把日志文件转化为图表。我用了GoogleDrive上的Excel做的。</p>
<h2 id="9-Blueprint-Optimizations-Or-Keeping-the-Kids-from-Eating-the-Crayons"><a href="#9-Blueprint-Optimizations-Or-Keeping-the-Kids-from-Eating-the-Crayons" class="headerlink" title="9.Blueprint Optimizations - Or:Keeping the Kids from Eating the Crayons"></a>9.Blueprint Optimizations - Or:Keeping the Kids from Eating the Crayons</h2><ul>
<li>Blueprints make it easy for folks to assemble gamepaly logic</li>
<li>Best results often come with engineer mentorship</li>
<li>Common challenge<ul>
<li>Reliance on Tick functionlity</li>
<li>Over-use of expensive functions(iterating on many objects)</li>
<li>Abuse of hard reference</li>
</ul>
</li>
</ul>
<h3 id="Reliance-on-Ticking-Blueprints"><a href="#Reliance-on-Ticking-Blueprints" class="headerlink" title="Reliance on Ticking Blueprints"></a>Reliance on Ticking Blueprints</h3><ul>
<li>Tick means should on every frame</li>
<li><p>Blueprints should almost never need Tick</p>
<ul>
<li>Remember to uncheck <em>Enable Actor Tick</em> in Class Defaults!<ul>
<li>This is on by default so that the Tick event will work</li>
</ul>
</li>
</ul>
</li>
<li><p>Alternatives to Tick</p>
<ul>
<li>Timers</li>
<li>Timelines</li>
<li>Manually enabling/disabling Tick on demand</li>
</ul>
</li>
<li>Make sure to adjust Tick Frequency<ul>
<li>0.0= every frame</li>
</ul>
</li>
</ul>
<h3 id="Expensive-Functionality"><a href="#Expensive-Functionality" class="headerlink" title="Expensive Functionality"></a>Expensive Functionality</h3><ul>
<li>Some functions are inherently expensive<ul>
<li>Get All Actors of Class</li>
<li>Spawn</li>
<li>Anything that needs to iterate over a large group of objects or properties</li>
</ul>
</li>
<li>Try not to use these if at all possiple<ul>
<li>If you are doing it to get a reference, consider having the referenced class pass itself up so the referencing object does not need to query</li>
<li>Use TSets instead of arrays</li>
</ul>
</li>
<li>If you must use them, do so as seldom as possible<ul>
<li>Perferably only once,such as at Begin Play</li>
</ul>
</li>
<li>Heavy ConstructionScripts can murder spawn times.<ul>
<li>Consider placing in the level beforehand</li>
</ul>
</li>
</ul>
<h3 id="Hard-References-in-Blueprint"><a href="#Hard-References-in-Blueprint" class="headerlink" title="Hard References in Blueprint"></a>Hard References in Blueprint</h3><ul>
<li>It is very easy for Blueprints to generate references to each other</li>
<li>When you load a Blueprint, every other Blueprint it references must be loaded<ul>
<li>And the Blueprints referenced by those</li>
<li>And so on,and so on..</li>
</ul>
</li>
<li>This will not slow dowwn in-game performance, but it can eat away at memory and load times</li>
<li><p>Some studios have thought the Editor just ran slow</p>
<ul>
<li>Turns out they were loading moost(ot all) of their game on startup</li>
</ul>
</li>
<li><p>Avoiding hard references:</p>
<ul>
<li><p>Avoiding casting operations unless you are certain you need them and know that it won’t cause issue</p>
<ul>
<li>For instance, if a Pickup class can only interact with the player, it might be fine to have it cast to Player</li>
<li>But having the Player class references every other type of pickup and interactive object in the game, you will likely see problems</li>
</ul>
</li>
<li><p>Instead, use Blueprint Interfaces</p>
</li>
<li>Try to get into the mentailty of not needin a very specific reference type<ul>
<li>Send your messages via an interface to a more generic class</li>
<li>If they land on something inplementing the interface, grate!</li>
<li>If not,no big deal</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Other-Blueprint-Optimizations"><a href="#Other-Blueprint-Optimizations" class="headerlink" title="Other Blueprint Optimizations"></a>Other Blueprint Optimizations</h3><ul>
<li>Avoiding doing too much of any one thing(like with any scripting language)<ul>
<li>Too much functionality in a sngle class<ul>
<li>Break things up</li>
<li>Use a class hierarchy<ul>
<li>But on that note, also avoid…</li>
</ul>
</li>
</ul>
</li>
<li>Class hierarchies that are too deep</li>
<li>Too many components within a class</li>
<li>Too much high-end math<ul>
<li>Use the Math Expression node- it’s optimized to speed things up</li>
</ul>
</li>
<li>When all else fails for BP performance: <strong>GO NATIVE</strong>!<ul>
<li>At Epic, many of our Blueprints derive from generic C++ classes</li>
<li>Yours should, too!</li>
<li>Keep all the heavy functionality in code, leave the lighter stuff for Blueprint</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="What-Actors-are-Ticking"><a href="#What-Actors-are-Ticking" class="headerlink" title="What Actors are Ticking?"></a>What Actors are Ticking?</h3><ul>
<li>Did you lose track of what’s ticking? Use <em><span style="color:green">dumpticks</span></em></li>
<li>Dumps a list of all ticking Actors out to the log, telling you how many tick functions are called</li>
<li>Also shows how many enabled and disabled ticking Actors are in the scene</li>
</ul>
<h2 id="10-Draw-Thread-Optimization"><a href="#10-Draw-Thread-Optimization" class="headerlink" title="10.Draw Thread Optimization"></a>10.Draw Thread Optimization</h2><h3 id="CPU-Rendering-Considerations"><a href="#CPU-Rendering-Considerations" class="headerlink" title="CPU Rendering Considerations"></a>CPU Rendering Considerations</h3><ul>
<li>Bottlenecks at the Draw thread are often caused by doing too much:<ul>
<li>Too many draw calls</li>
<li>Occlusion queries - see above</li>
<li>Simulating too many particles</li>
<li>Adding too many lights - often hits the GPU harder</li>
</ul>
</li>
<li>Generally the best way to speed up the Draw thread is to do less</li>
<li>Find every way you can to put fewer things on the screen</li>
<li>Generally this means either being very clever with content or using the integrated tools within UE4 start combining objects</li>
</ul>
<h3 id="Actor-Merge-Tool"><a href="#Actor-Merge-Tool" class="headerlink" title="Actor Merge Tool"></a>Actor Merge Tool</h3><ul>
<li>Located under <em>Window &gt; Developer Tools</em></li>
<li>Combines selection of meshes in to new asset, replacing originals</li>
<li>Can also combine Material via Simplygon</li>
<li>Works best with many meshes having the same Material</li>
</ul>
<blockquote>
<p>The Actor Merge tool works best with many meshed that have the same materials as possible.If you try to combine 20 meshed and each has its own Material every materail,you are not benefiting from the tool because every material is going to make a draw call anyway.</p>
</blockquote>
<h3 id="Instanced-Static-Meshes"><a href="#Instanced-Static-Meshes" class="headerlink" title="Instanced Static Meshes"></a>Instanced Static Meshes</h3><ul>
<li>Mechanism for generating multiple instances of a given mesh, with each considered part of the same mesh object.</li>
<li>Can only be created throuth code or Blueprint at this time, often via the Construction Script</li>
<li>Very easy to create a Blueprint set that helps generate this<ul>
<li>Placement Blueprint that is used to preview where mesh will be</li>
<li>Radius based ISM Blueprint that gathers transforms from Preview BPs and populates the instances with itself.</li>
<li>Be careful of Editor Utility class BPs-they’re Editor only!</li>
</ul>
</li>
<li>Also consider <em>Hierarchical Instanced Static Meshes</em><ul>
<li>Handle their own occlusion/visibility</li>
</ul>
</li>
</ul>
<h3 id="Hierarchical-LOD"><a href="#Hierarchical-LOD" class="headerlink" title="Hierarchical LOD"></a>Hierarchical LOD</h3><ul>
<li>Hierarchical LODs allow multiple meshed to be combined and then reduced as a single mesh</li>
<li>Will also combine textures into atlases. reducing overall Material demands</li>
<li>Very useful for buildings and cities, groups of large meshes that need to be viewed at extreme distance</li>
<li>Requires Simplygon implementation</li>
</ul>
<h2 id="11-GPU-Optimizations-What-to-do-about-all-those-pixels"><a href="#11-GPU-Optimizations-What-to-do-about-all-those-pixels" class="headerlink" title="11.GPU Optimizations - What to do about all those pixels"></a>11.GPU Optimizations - What to do about all those pixels</h2><h3 id="Vertex-Shader-Optimizatin"><a href="#Vertex-Shader-Optimizatin" class="headerlink" title="Vertex Shader Optimizatin"></a>Vertex Shader Optimizatin</h3><ul>
<li>Be careful how much you make use of World Position Offset<ul>
<li>Often cheaper than the alternative methods of vertex animation</li>
</ul>
</li>
<li>Vertex color can eventually get costly<ul>
<li>On Paragon, we ended up stripping it and adding it back per instance</li>
</ul>
</li>
</ul>
<h3 id="Pixel-Shader-Optimizations"><a href="#Pixel-Shader-Optimizations" class="headerlink" title="Pixel Shader Optimizations"></a>Pixel Shader Optimizations</h3><p><span style="color:red">Pixel Shader Don’ts</span></p>
<ul>
<li>Too much math</li>
<li>Too many textures</li>
<li>Too many procedural functions<ul>
<li>noise</li>
</ul>
</li>
<li>Too many Material layers</li>
<li>Reliance on lfs(if statements)<ul>
<li>Both sides have to calculate</li>
</ul>
</li>
</ul>
<p><span style="color:green">Pixel Shader Dos</span></p>
<ul>
<li>Use textures for lookups instead of mesh</li>
<li>Compress greyscale maps into single textures</li>
<li>Minimize Layer usage</li>
<li>Use Switch Parameters to turn off what you don’t need</li>
</ul>
<h3 id="Material-Instruction-Counts"><a href="#Material-Instruction-Counts" class="headerlink" title="Material Instruction Counts"></a>Material Instruction Counts</h3><ul>
<li>Always pay attention to Material instruction counts</li>
<li>Caution: the number indicated is not accurate until you click Apply<ul>
<li>Sometimes it’s best to re-compile the Material just to be safe</li>
</ul>
</li>
</ul>
<h3 id="Dealing-with-Overdraw"><a href="#Dealing-with-Overdraw" class="headerlink" title="Dealing with Overdraw"></a>Dealing with Overdraw</h3><ul>
<li>Overdraw is one of the leading causes of GPU slogging</li>
<li>Minimize the geometry area for overdraw<ul>
<li>Adding vertices is almost aways cheaper than relying in overdraw</li>
<li>For example, on A Boy and His Kite,we ended up cutting the grass planes to almost exactly match the outline of the grass texture alpha</li>
</ul>
</li>
<li>Make use of Particle Cutout property<ul>
<li>This is found under the Cascade Required Moudle</li>
<li>Feed it a texture, it automatically snips the spite</li>
<li>Also works in subUVs,with a different cutout for every frame</li>
</ul>
</li>
</ul>
<h3 id="Managing-Texture-Resolution"><a href="#Managing-Texture-Resolution" class="headerlink" title="Managing Texture Resolution"></a>Managing Texture Resolution</h3><ul>
<li>Author texture at whatever resolution you like,but keep in mind you may not always use full resolution</li>
<li>Use the Texture Streaming view to see what level of mips you’re using for any given texture</li>
<li>You can use the Statistics panel set to Texture Staticstics to see what levl of mips you are using at current levels</li>
<li>Then use the Texture Editor to force mip bias</li>
<li>Or better yet,reimport at lower resolution</li>
</ul>
<h3 id="Lighting-Considerations"><a href="#Lighting-Considerations" class="headerlink" title="Lighting Considerations"></a>Lighting Considerations</h3><ul>
<li><p>Dynamic lights are expensive (but somewhat cheaper in deferred)</p>
<ul>
<li>Small,unshadowed lights are the cheapest!</li>
<li>You can have lots of these</li>
</ul>
</li>
<li><p>Minimize number of dynamic lights</p>
</li>
<li>Minimize number of things dynamic lights have to effect</li>
<li>Minimize dynamic light radii -tighter is better</li>
<li>Cast shadows from as few dynamic lights as possible<ul>
<li>Dynamic shadow casting lights are the most expensive in UE</li>
</ul>
</li>
<li><p>Watch out for Stationary Light Overlap</p>
<ul>
<li>The fallback to dynamic lighting is extremely expensive</li>
</ul>
</li>
<li><p>Bake whenever you can</p>
</li>
<li>Don’t assume you need dynamic lights</li>
<li>Use Mesh Distance Field shadows at distance</li>
<li>Watch out for dense shado cascades</li>
<li>Many artifacts are cleaned up with Shadow Bias,but be gentle</li>
<li><p>Keep Lightmap Res as low as you can</p>
<ul>
<li>Use the view mode,keep it blue as much as possible</li>
</ul>
</li>
<li><p>Avoid Light Function unless you really need them</p>
<ul>
<li>Consider IES profiles, but understand they also have a cost</li>
</ul>
</li>
<li>Lit translucency gets expensive, use with caution</li>
<li>Cull shadows early (at close distance as possible)</li>
<li>Cull dynamic lights as early as possible</li>
<li>Spot lights are cheaper than Point lights</li>
<li>Don’t be afraid to completely fake shadows<ul>
<li>We do this a lot, especially for VR</li>
</ul>
</li>
</ul>
<h3 id="Replication-Optimization"><a href="#Replication-Optimization" class="headerlink" title="Replication Optimization"></a>Replication Optimization</h3><ul>
<li>Common problems for networking:<ul>
<li>Doing too much</li>
<li>Doing it too much</li>
</ul>
</li>
<li>Replicate as little as you can, as seldom as you can</li>
<li>Use <span style="color:green">net.*</span>  commands to check what’s going on<ul>
<li>Must be run on the sever<ul>
<li>Use cheat net.* to run the command on the server from the client</li>
</ul>
</li>
<li>Use net.DumpRelevantActors to see what is currently replicating<ul>
<li>This command features some improvements as of 4.19</li>
</ul>
</li>
<li>There are a lot of these net.* commands - check online for full list</li>
</ul>
</li>
</ul>
<h3 id="Network-Relevancy-View-Mode-4-19"><a href="#Network-Relevancy-View-Mode-4-19" class="headerlink" title="Network Relevancy View Mode(4.19)"></a>Network Relevancy View Mode(4.19)</h3><p>…</p>
<p>我已经不知道他在讲什么了。。</p>
<h2 id="12-Content-Streaming"><a href="#12-Content-Streaming" class="headerlink" title="12.Content Streaming"></a>12.Content Streaming</h2><h3 id="Texture-Streaming"><a href="#Texture-Streaming" class="headerlink" title="Texture Streaming"></a>Texture Streaming</h3><ul>
<li>Textures streaming into and out of your scene at inopportune times cause visible pops</li>
<li>As of 4.15 we have some tools for texture streaming diagnostics<ul>
<li>Texture streaming view mode<ul>
<li>Primitive Distance Accuracy</li>
<li>Mesh Densities Accuracy</li>
<li>Material Texture Scales Accuracy</li>
<li>Required Texture Resolution</li>
</ul>
</li>
<li><span style="color:green">stat streaming</span></li>
</ul>
</li>
</ul>
<h4 id="Primitive-Distance-Accuracy"><a href="#Primitive-Distance-Accuracy" class="headerlink" title="Primitive Distance Accuracy"></a>Primitive Distance Accuracy</h4><ul>
<li>Visialization system for texture streaming</li>
<li><p>Enable users to see what mips the system things they should be using, allowing for intelligent mip limits</p>
<ul>
<li><span style="color:red">Red = 2 or more mips too few</span></li>
<li><span style="color:orange">Orange = 1 mip too few</span></li>
<li><span style="color:blue">White = the right degree of mips</span></li>
<li><span style="color:cyan">Cyan = 1 mip too many</span></li>
<li><span style="color:green">Green = 2 or more mips too many</span></li>
</ul>
</li>
<li><p>This setting can be adjusted using the <em><span style="color:green">StreamingDistanceMultiplier</span></em> property</p>
</li>
</ul>
<h4 id="Mesh-UV-Densities-Accuracy"><a href="#Mesh-UV-Densities-Accuracy" class="headerlink" title="Mesh UV Densities Accuracy"></a>Mesh UV Densities Accuracy</h4><ul>
<li>This uses the density of a mesh’s UVs</li>
<li>Visualizes how those UV densities are distributing to densities are contributing to streaming data</li>
<li><p>Use the same paradigm as Primitive Distance Accuracy</p>
<ul>
<li><span style="color:red">Red = 2 or more mips too few</span></li>
<li><span style="color:orange">Orange = 1 mip too few</span></li>
<li><span style="color:blue">White = the right degree of mips</span></li>
<li><span style="color:cyan">Cyan = 1 mip too many</span></li>
<li><span style="color:green">Green = 2 or more mips too many</span></li>
</ul>
</li>
<li><p>Fixing this requires the UVs on each mesh to be adjuested</p>
</li>
</ul>
<h4 id="Material-Texture-Scales-Accuracy"><a href="#Material-Texture-Scales-Accuracy" class="headerlink" title="Material Texture Scales Accuracy"></a>Material Texture Scales Accuracy</h4><ul>
<li>This view mode samples all textures and feeds back the worst culprits for over-streaming and under-streaming</li>
<li><p>Data is based on streaming affected by textures that have had their UVs scaled</p>
</li>
<li><p>Helps diagnose streaming errors caused by UV scaling</p>
</li>
</ul>
<h4 id="Required-Texture-Resolution"><a href="#Required-Texture-Resolution" class="headerlink" title="Required Texture Resolution"></a>Required Texture Resolution</h4><ul>
<li>This mode shows te required resolution for the given texture, indicating how many mips under or over it is</li>
<li>Helps show the delta between the ideal resolution for the texture-what the GPU wants to show-and what is the GPU wants to show- and what is currenrly avaliable<ul>
<li><span style="color:red">Red = 2 or more mips too few</span></li>
<li><span style="color:orange">Orange = 1 mip too few</span></li>
<li><span style="color:blue">White = the right degree of mips</span></li>
<li><span style="color:cyan">Cyan = 1 mip too many</span></li>
<li><span style="color:green">Green = 2 or more mips too many</span></li>
</ul>
</li>
</ul>
<h4 id="Stat-Streaming"><a href="#Stat-Streaming" class="headerlink" title="Stat Streaming"></a>Stat Streaming</h4><ul>
<li>Realtime metrics on texture streaming memory usage</li>
<li>Breaks down texure streaming memory into 3 pools<ul>
<li>Texture</li>
<li>Streaming</li>
<li>Wanted</li>
</ul>
</li>
</ul>
<h4 id="Level-Streaming"><a href="#Level-Streaming" class="headerlink" title="Level Streaming"></a>Level Streaming</h4><ul>
<li>Level streaming is an ideal way to control what content is in use in your game</li>
<li>What you currently need is streamed in, what you don’t is streamed out</li>
<li>Be careful how much you stream at once!<ul>
<li>You may need negate some of the benefit if you have over-referenced your content within code or Blueprint</li>
</ul>
</li>
</ul>
<h4 id="Bonus-Level-Streaming-as-Collaboration"><a href="#Bonus-Level-Streaming-as-Collaboration" class="headerlink" title="Bonus: Level Streaming as Collaboration"></a>Bonus: Level Streaming as Collaboration</h4><ul>
<li>Level Streaming is also the primary way for level artists to work together</li>
<li>Different aspects are separated into different levels<ul>
<li>Not just different physical zones<h4 id="World-Composition"><a href="#World-Composition" class="headerlink" title="World Composition"></a>World Composition</h4></li>
</ul>
</li>
<li>Specialized streaming system designed for large worlds</li>
<li>Will not work with old-school level streaming volimes</li>
<li>But WILL work with Blueprint streaming<ul>
<li>Pro Tips: You can very easily make a Blueprint that functions just like a Level Streaming volume and does exactly the same thing, only better.</li>
</ul>
</li>
</ul>
<h1 id="GPU-Performance-for-Game-Artists"><a href="#GPU-Performance-for-Game-Artists" class="headerlink" title="GPU Performance for Game Artists"></a>GPU Performance for Game Artists</h1><p>这是上面的视频里大力推荐的一篇文章。有时间我也得看一下，去理解一下整理一下。</p>
<ul>
<li><a href="www.fragmentbuffer.com/gpu-performance-for-game-artists/">GPU Performance for Game Artists</a></li>
</ul>
<h1 id="Tech-Art-Aid-videos-on-Youtube"><a href="#Tech-Art-Aid-videos-on-Youtube" class="headerlink" title="Tech Art Aid videos on Youtube"></a>Tech Art Aid videos on Youtube</h1><p>这个在油管上的视频我一直在看了，在这儿记录一下网址：</p>
<ul>
<li><a href="https://www.youtube.com/playlist?list=PLF8ktr3i-U4A7vuQ6TXPr3f-bhmy6xM3S" target="_blank" rel="noopener">UE4 Graphics Profiling</a></li>
</ul>

      
    </div>
    
    
    

    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文完-------------</div>
    
</div>

      
    </div>

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    stone
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://stonelzp.github.io/2019/03/19/UE4-Performance提升/" title="UE4-Performance提升">http://stonelzp.github.io/2019/03/19/UE4-Performance提升/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/UE4/" rel="tag"><i class="fa fa-tag"></i> UE4</a>
          
            <a href="/tags/Performance/" rel="tag"><i class="fa fa-tag"></i> Performance</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/15/UE4光照学习调查笔记/" rel="next" title="UE4光照学习调查笔记">
                <i class="fa fa-chevron-left"></i> UE4光照学习调查笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/11/UE4-Material学习/" rel="prev" title="UE4-Material学习">
                UE4-Material学习 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.gif"
                alt="stone" />
            
              <p class="site-author-name" itemprop="name">stone</p>
              <p class="site-description motion-element" itemprop="description">爱自己，对爱你的人来说，是最大的安慰</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/stonelzp" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by.svg" alt="Creative Commons" />
              </a>
            </div>
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Optimization"><span class="nav-number">1.</span> <span class="nav-text">Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Emulate-HMD-performance"><span class="nav-number">1.1.</span> <span class="nav-text">Emulate HMD performance</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ready-Profiling"><span class="nav-number">1.2.</span> <span class="nav-text">Ready Profiling</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VR-Instanced-Stereo"><span class="nav-number">1.3.</span> <span class="nav-text">VR Instanced Stereo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Base-Pass"><span class="nav-number">1.4.</span> <span class="nav-text">1.Base Pass</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Optimization-1"><span class="nav-number">1.4.1.</span> <span class="nav-text">Optimization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GPU-Visualizer"><span class="nav-number">1.4.2.</span> <span class="nav-text">GPU Visualizer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-BasePass-Dynamic"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">1.BasePass-Dynamic</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-PrePass"><span class="nav-number">1.5.</span> <span class="nav-text">2.PrePass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Translucency"><span class="nav-number">1.6.</span> <span class="nav-text">3.Translucency</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Separate-Translucency"><span class="nav-number">1.6.1.</span> <span class="nav-text">Separate Translucency</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Shadow"><span class="nav-number">1.7.</span> <span class="nav-text">4.Shadow</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Fake-Shadow"><span class="nav-number">1.7.1.</span> <span class="nav-text">Fake Shadow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Capsule-Shadow"><span class="nav-number">1.7.2.</span> <span class="nav-text">Capsule Shadow</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Command-Introduction"><span class="nav-number">1.8.</span> <span class="nav-text">Command Introduction</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#stat-SceneRendering"><span class="nav-number">1.8.1.</span> <span class="nav-text">stat SceneRendering</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RenderQueryResult"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">RenderQueryResult</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Bluerint优化"><span class="nav-number">2.</span> <span class="nav-text">Bluerint优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Tick-Event"><span class="nav-number">2.1.</span> <span class="nav-text">Tick Event</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spawn"><span class="nav-number">2.2.</span> <span class="nav-text">Spawn</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nativizing-Blueprint"><span class="nav-number">2.3.</span> <span class="nav-text">Nativizing Blueprint</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Landscape-Optimization"><span class="nav-number">3.</span> <span class="nav-text">Landscape Optimization</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HTC-Vive"><span class="nav-number">4.</span> <span class="nav-text">HTC Vive</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Smoothed-Frame-Rate-Range"><span class="nav-number">4.1.</span> <span class="nav-text">Smoothed Frame Rate Range</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#UE4中的一些概念"><span class="nav-number">5.</span> <span class="nav-text">UE4中的一些概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Instanced-Static-Mesh"><span class="nav-number">5.1.</span> <span class="nav-text">Instanced Static Mesh</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#剔除"><span class="nav-number">5.1.1.</span> <span class="nav-text">剔除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于OcclusionCulling的一些问题"><span class="nav-number">5.1.2.</span> <span class="nav-text">关于OcclusionCulling的一些问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单的Profiling"><span class="nav-number">5.1.3.</span> <span class="nav-text">简单的Profiling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Render-Query-Result"><span class="nav-number">5.1.4.</span> <span class="nav-text">Render Query Result</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何正确的使用"><span class="nav-number">5.1.5.</span> <span class="nav-text">如何正确的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Culling-Distance"><span class="nav-number">5.1.6.</span> <span class="nav-text">Culling Distance</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#UE4-Performance-and-Profiling"><span class="nav-number">6.</span> <span class="nav-text">UE4 Performance and Profiling</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-CPU-GPU-Profiler"><span class="nav-number">6.1.</span> <span class="nav-text">1.CPU/GPU Profiler</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Profiling-in-a-Build"><span class="nav-number">6.2.</span> <span class="nav-text">2.Profiling in a Build</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Profiling-from-within-the-Editor"><span class="nav-number">6.3.</span> <span class="nav-text">3.Profiling from within the Editor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-General-Process"><span class="nav-number">6.4.</span> <span class="nav-text">4.General Process</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Game-Thread"><span class="nav-number">6.4.1.</span> <span class="nav-text">Game Thread</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU-Render"><span class="nav-number">6.4.2.</span> <span class="nav-text">CPU Render</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GPU-Render"><span class="nav-number">6.4.3.</span> <span class="nav-text">GPU Render</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Measuring-in-Milliseconds"><span class="nav-number">6.5.</span> <span class="nav-text">5.Measuring in Milliseconds</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ScreenPercentage"><span class="nav-number">6.5.1.</span> <span class="nav-text">ScreenPercentage</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Show-Flags"><span class="nav-number">6.6.</span> <span class="nav-text">6.Show Flags</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Diagnostic-Tools-Realtime-stats-and-view-modes"><span class="nav-number">6.7.</span> <span class="nav-text">7.Diagnostic Tools-Realtime stats and view modes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Stat-commands"><span class="nav-number">6.7.1.</span> <span class="nav-text">Stat commands</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Stat-SceneRendering"><span class="nav-number">6.7.1.1.</span> <span class="nav-text">Stat SceneRendering</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Stat-GPU"><span class="nav-number">6.7.1.2.</span> <span class="nav-text">Stat GPU</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Optimization-View-Modes"><span class="nav-number">6.7.2.</span> <span class="nav-text">Optimization View Modes</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Shader-Complexity"><span class="nav-number">6.7.2.1.</span> <span class="nav-text">Shader Complexity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Quad-Overdraw"><span class="nav-number">6.7.2.2.</span> <span class="nav-text">Quad Overdraw</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Quad-Overdraw-in-depth"><span class="nav-number">6.7.2.3.</span> <span class="nav-text">Quad Overdraw in-depth</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Shader-Complexity-Quad-Overdraw"><span class="nav-number">6.7.2.4.</span> <span class="nav-text">Shader Complexity + Quad Overdraw</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Liht-Complexity"><span class="nav-number">6.7.2.5.</span> <span class="nav-text">Liht Complexity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Lightmap-Density"><span class="nav-number">6.7.2.6.</span> <span class="nav-text">Lightmap Density</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Stationary-Light-Overlap"><span class="nav-number">6.7.2.7.</span> <span class="nav-text">Stationary Light Overlap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LOD-Coloration"><span class="nav-number">6.7.2.8.</span> <span class="nav-text">LOD Coloration</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-Profilling-Tools"><span class="nav-number">6.8.</span> <span class="nav-text">8.Profilling Tools</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU-Profiling"><span class="nav-number">6.8.1.</span> <span class="nav-text">CPU Profiling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GPU-Profiling"><span class="nav-number">6.8.2.</span> <span class="nav-text">GPU Profiling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tracking-Slow-Frame"><span class="nav-number">6.8.3.</span> <span class="nav-text">Tracking Slow Frame</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startFPSChart-and-stopFPSChart"><span class="nav-number">6.8.4.</span> <span class="nav-text">startFPSChart and stopFPSChart</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-Blueprint-Optimizations-Or-Keeping-the-Kids-from-Eating-the-Crayons"><span class="nav-number">6.9.</span> <span class="nav-text">9.Blueprint Optimizations - Or:Keeping the Kids from Eating the Crayons</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Reliance-on-Ticking-Blueprints"><span class="nav-number">6.9.1.</span> <span class="nav-text">Reliance on Ticking Blueprints</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Expensive-Functionality"><span class="nav-number">6.9.2.</span> <span class="nav-text">Expensive Functionality</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hard-References-in-Blueprint"><span class="nav-number">6.9.3.</span> <span class="nav-text">Hard References in Blueprint</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Other-Blueprint-Optimizations"><span class="nav-number">6.9.4.</span> <span class="nav-text">Other Blueprint Optimizations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#What-Actors-are-Ticking"><span class="nav-number">6.9.5.</span> <span class="nav-text">What Actors are Ticking?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-Draw-Thread-Optimization"><span class="nav-number">6.10.</span> <span class="nav-text">10.Draw Thread Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU-Rendering-Considerations"><span class="nav-number">6.10.1.</span> <span class="nav-text">CPU Rendering Considerations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Actor-Merge-Tool"><span class="nav-number">6.10.2.</span> <span class="nav-text">Actor Merge Tool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Instanced-Static-Meshes"><span class="nav-number">6.10.3.</span> <span class="nav-text">Instanced Static Meshes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hierarchical-LOD"><span class="nav-number">6.10.4.</span> <span class="nav-text">Hierarchical LOD</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-GPU-Optimizations-What-to-do-about-all-those-pixels"><span class="nav-number">6.11.</span> <span class="nav-text">11.GPU Optimizations - What to do about all those pixels</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Vertex-Shader-Optimizatin"><span class="nav-number">6.11.1.</span> <span class="nav-text">Vertex Shader Optimizatin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pixel-Shader-Optimizations"><span class="nav-number">6.11.2.</span> <span class="nav-text">Pixel Shader Optimizations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Material-Instruction-Counts"><span class="nav-number">6.11.3.</span> <span class="nav-text">Material Instruction Counts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dealing-with-Overdraw"><span class="nav-number">6.11.4.</span> <span class="nav-text">Dealing with Overdraw</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Managing-Texture-Resolution"><span class="nav-number">6.11.5.</span> <span class="nav-text">Managing Texture Resolution</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lighting-Considerations"><span class="nav-number">6.11.6.</span> <span class="nav-text">Lighting Considerations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Replication-Optimization"><span class="nav-number">6.11.7.</span> <span class="nav-text">Replication Optimization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Network-Relevancy-View-Mode-4-19"><span class="nav-number">6.11.8.</span> <span class="nav-text">Network Relevancy View Mode(4.19)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-Content-Streaming"><span class="nav-number">6.12.</span> <span class="nav-text">12.Content Streaming</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Texture-Streaming"><span class="nav-number">6.12.1.</span> <span class="nav-text">Texture Streaming</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Primitive-Distance-Accuracy"><span class="nav-number">6.12.1.1.</span> <span class="nav-text">Primitive Distance Accuracy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mesh-UV-Densities-Accuracy"><span class="nav-number">6.12.1.2.</span> <span class="nav-text">Mesh UV Densities Accuracy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Material-Texture-Scales-Accuracy"><span class="nav-number">6.12.1.3.</span> <span class="nav-text">Material Texture Scales Accuracy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Required-Texture-Resolution"><span class="nav-number">6.12.1.4.</span> <span class="nav-text">Required Texture Resolution</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Stat-Streaming"><span class="nav-number">6.12.1.5.</span> <span class="nav-text">Stat Streaming</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Level-Streaming"><span class="nav-number">6.12.1.6.</span> <span class="nav-text">Level Streaming</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Bonus-Level-Streaming-as-Collaboration"><span class="nav-number">6.12.1.7.</span> <span class="nav-text">Bonus: Level Streaming as Collaboration</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#World-Composition"><span class="nav-number">6.12.1.8.</span> <span class="nav-text">World Composition</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GPU-Performance-for-Game-Artists"><span class="nav-number">7.</span> <span class="nav-text">GPU Performance for Game Artists</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tech-Art-Aid-videos-on-Youtube"><span class="nav-number">8.</span> <span class="nav-text">Tech Art Aid videos on Youtube</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">stone</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
